<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="shared-style.html">
<dom-module id="nsr-episode">
  <template>
    <style>
      .ok{
        color: green;
      }
      .selfDanger{
        color:red;
      }
      .otherDanger{
        color:orange;
      }
      .episode{
        width: 100%;
        padding: 5px;
        overflow-wrap: break-word;
      }
    </style>
    <firebase-document
        app-name="noSpoilRoom"
        path = "/viewed/{{path}}"
	      data = "{{episodeState}}"
        id="dEpisodeState">
    </firebase-document>
    <div class$="episode [[state]]">
      {{episodeRef.titre}} <paper-icon-button
          icon="[[computeCheckClass(checked)]]"
          on-tap="checkTap">
      </paper-icon-button>
    </div>
  </template>
  <script>
    Polymer({
      is: 'nsr-episode',

      properties: {
        episodeRef:{
            type:Object
        },
        episodeState:{
            type:Object
        },
        profil:{
          type:Object
        },
        checked:{
          type:Boolean,
          computed:'computeChecked(episodeState.*)'
        },
        state:{
          type:String,
          computed:'computeState(episodeState.*)',
          observer:'stateChanged'
        },
        nbUser:{
          type:Number
        },
        action:{
          type:String,
          observer:'actionChanged'
        }
      },
      stateChanged:function(newState, oldState){
        if(newState != oldState){
          this.fire('state-changed', {"state":this.state, "numero":this.episodeRef.numero});
        }
      },
      actionChanged:function(newAction, oldAction){
          if(this.action == "check" && !this.checked){
            this.checkTap();
          }
      },
      computeCheckClass: function(checked) {
        return checked ? 'check' : 'check-box-outline-blank';
      },
      checkTap:function(){
        
        if(!this.episodeState){
          this.episodeState = {};
        }

        //this.episodeState[this.profil.uid] = !this.episodeState[this.profil.uid] ? Date.now() : null;
        var updates = {}
        updates['/viewed/'+this.path+'/'+this.profil.uid] = !this.episodeState[this.profil.uid] ? Date.now() : null;
        this.fire('add-update', updates);
        //this.fire('save-room');
      },
      computeChecked: function(episodeState){
        ////console.log("compute checked")
        if(!this.episodeState || !this.profil){
          ////console.log("compute checked error")
          return false;
        }
        return !!this.episodeState[this.profil.uid];
      },
      computeState: function(episodeState){
        //console.log("check state", this.nbUser, this.episodeState, Object.keys(this.episodeState).length);
        if(!this.profil || Object.keys(this.episodeState).length == 0){
          return '';
        }
        if(this.nbUser == Object.keys(this.episodeState).length){
          return 'ok';
        }
        return !!this.episodeState[this.profil.uid] ? 'selfDanger' : 'otherDanger'
      }
    });
  </script>
</dom-module>